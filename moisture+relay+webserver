#include <WiFi.h>
#include <WiFiClient.h>
#include <WiFiAP.h>
#include <AsyncTCP.h>
#include <ESPAsyncWebServer.h>
#include <ArduinoMqttClient.h>
#include <ArduinoJson.h>
#include <Preferences.h>

#define NUM_SENSORS 6

struct Config {
  String ssid = "ssid";
  String wifi_password = "password";
  String mqtt_server = "mqtt_address";
  String mqtt_username = "mqtt_username";
  String mqtt_password = "mqtt_pass";
  String clientID = "device_name";
  String mqtt_topic = "domoticz/in";
  int SensorPin[NUM_SENSORS] = {36, 39, 34, 35, 32, 33};
  int rawValueRange[2] = {2830, 890}; // Dry-wet
  int scaleRange[2] = {200, 0}; // Dry-wet
  int relayPin = 26;
  int moistureThreshold = 100;
  long relayOnTime = 10; // Time in seconds
  unsigned long pollIntervalMinutes = 60; // Default: 60 minutes
  int numberOfSamples = 10; // Default: 10 samples
  int requiredMoistureSensors = 3;
  int sensorIdx[NUM_SENSORS] = {506, 507, 508, 509, 510, 511}; // Sensor indices for MQTT messages
};

Config config;
Preferences preferences;
WiFiClient wifiClient;
MqttClient mqttClient(wifiClient);
AsyncWebServer server(80);
int lastPublishedValues[NUM_SENSORS] = {0};
unsigned long relayOffTime = 0; // For non-blocking relay timing
bool relayOn = false; // Relay state tracking

// Maps sensor value to a defined scale
int mapSensorValue(int rawValue) {
  return map(rawValue, config.rawValueRange[0], config.rawValueRange[1], config.scaleRange[0], config.scaleRange[1]);
}

// Parses comma-separated string values into an integer array
void parseCommaSeparatedValues(String input, int* outputArray, int arraySize) {
  int idx = 0, lastIdx = 0, arrayIdx = 0;
  while ((idx = input.indexOf(',', lastIdx)) != -1 && arrayIdx < arraySize) {
    outputArray[arrayIdx++] = input.substring(lastIdx, idx).toInt();
    lastIdx = idx + 1;
  }
  if (arrayIdx < arraySize) { // Handle the last value
    outputArray[arrayIdx] = input.substring(lastIdx).toInt();
  }
}

// Saves configuration to non-volatile storage (NVS)
void saveConfig() {
    preferences.begin("config", false);
    preferences.putString("ssid", config.ssid);
    preferences.putString("wifi_password", config.wifi_password);
    preferences.putString("mqtt_server", config.mqtt_server);
    preferences.putString("mqtt_username", config.mqtt_username);
    preferences.putString("mqtt_password", config.mqtt_password);
    preferences.putString("clientID", config.clientID);
    preferences.putString("mqtt_topic", config.mqtt_topic);
    preferences.putInt("relayPin", config.relayPin);
    preferences.putInt("moistureThreshold", config.moistureThreshold);
    preferences.putInt("relayOnTime", config.relayOnTime);
    preferences.putInt("pollIntervalMinutes", config.pollIntervalMinutes);
    preferences.putInt("numberOfSamples", config.numberOfSamples);
    preferences.putInt("requiredMoistureSensors", config.requiredMoistureSensors);
    for(int i = 0; i < NUM_SENSORS; i++) {
      preferences.putInt(String("sensorIdx") + i, config.sensorIdx[i]);
    }
    preferences.end();
}

// Loads configuration from non-volatile storage (NVS)
void loadConfig() {
    preferences.begin("config", true);
    config.ssid = preferences.getString("ssid", config.ssid);
    config.wifi_password = preferences.getString("wifi_password", config.wifi_password);
    config.mqtt_server = preferences.getString("mqtt_server", config.mqtt_server);
    config.mqtt_username = preferences.getString("mqtt_username", config.mqtt_username);
    config.mqtt_password = preferences.getString("mqtt_password", config.mqtt_password);
    config.clientID = preferences.getString("clientID", config.clientID);
    config.mqtt_topic = preferences.getString("mqtt_topic", config.mqtt_topic);
    config.relayPin = preferences.getInt("relayPin", config.relayPin);
    config.moistureThreshold = preferences.getInt("moistureThreshold", config.moistureThreshold);
    config.relayOnTime = preferences.getInt("relayOnTime", config.relayOnTime);
    config.pollIntervalMinutes = preferences.getInt("pollIntervalMinutes", config.pollIntervalMinutes);
    config.numberOfSamples = preferences.getInt("numberOfSamples", config.numberOfSamples);
    config.requiredMoistureSensors = preferences.getInt("requiredMoistureSensors", config.requiredMoistureSensors);
    for(int i = 0; i < 6; i++) { // Load sensor indices
      config.sensorIdx[i] = preferences.getInt(String("sensorIdx") + i, config.sensorIdx[i]);
    }
    preferences.end();
}

// Connects to WiFi network or creates an ad-hoc network if connection fails
void connectToWiFi() {
  Serial.print("Connecting to WiFi: ");
  Serial.println(config.ssid);
  WiFi.begin(config.ssid.c_str(), config.wifi_password.c_str());
  unsigned long startTime = millis();
  while (WiFi.status() != WL_CONNECTED && millis() - startTime < 30000) { // 30 seconds timeout
    delay(500);
    Serial.print(".");
  }
  if (WiFi.status() == WL_CONNECTED) {
    Serial.println("WiFi connected");
    Serial.print("IP address: ");
    Serial.println(WiFi.localIP());
  } else {
    Serial.println("Failed to connect to WiFi. Creating an ad-hoc network...");
    // Explicitly setting WiFi mode to AP (Access Point)
    WiFi.mode(WIFI_AP);
    IPAddress local_IP(192, 168, 1, 1);
    IPAddress gateway(192, 168, 1, 1);
    IPAddress subnet(255, 255, 255, 0);
    if (!WiFi.softAPConfig(local_IP, gateway, subnet)) {
      Serial.println("AP Config Failed");
      return;
    }
    // Attempting to create Soft AP
    bool apSuccess = WiFi.softAP("Plants"); // SSID for the ad-hoc network
    if(apSuccess) {
        Serial.print("Ad-hoc network SSID: 'Plants' with IP: ");
        Serial.println(WiFi.softAPIP());
    } else {
        Serial.println("Failed to create ad-hoc network. Please check the configuration and device capabilities.");
    }
  }
}
// Connects to the MQTT server
void connectToMQTT() {
  mqttClient.setId(config.clientID.c_str());
  mqttClient.setUsernamePassword(config.mqtt_username.c_str(), config.mqtt_password.c_str());
  int attempts = 0; // Counter for connection attempts
  while (!mqttClient.connect(config.mqtt_server.c_str(), 1883) && attempts < 5) {
    Serial.print(".");
    delay(5000); // Wait 5 seconds before the next attempt
    attempts++; // Increment the attempt counter
  }
  if (attempts < 5) {
    Serial.println("\nConnected to MQTT");
  } else {
    Serial.println("\nFailed to connect to MQTT, proceeding without MQTT functionality.");
  }
}

// Connects to WiFi and MQTT
void connectToNetwork() {
  connectToWiFi();
  connectToMQTT();
}

// Sets up the web server and handles GET and POST requests
void setupWebServer() {
  server.on("/", HTTP_GET, [](AsyncWebServerRequest *request) {
    // Generate HTML form with current configuration values
    String html = "<html><body><h1>Plant Monitoring System</h1>"
                  "<form action='/submit' method='POST'>"
                  "SSID: <input type='text' name='ssid' value='" + config.ssid + "'><br>"
                  "WiFi Password: <input type='password' name='wifiPassword' value='" + config.wifi_password + "'><br>"
                  "Sensor Pins (comma-separated): <input type='text' name='sensorPins' value='";
    for (int i = 0; i < 6; i++) {
      html += String(config.SensorPin[i]);
      if (i < 5) html += ",";
    }
    html += "'><br>"
            "Sensor IDXs (comma-separated): <input type='text' name='sensorIdxs' value='";
    for (int i = 0; i < 6; i++) {
      html += String(config.sensorIdx[i]);
      if (i < 5) html += ",";
    }
    html += "'><br>"
            "MQTT Server: <input type='text' name='mqttServer' value='" + config.mqtt_server + "'><br>"
            "MQTT Topic: <input type='text' name='mqttTopic' value='" + config.mqtt_topic + "'><br>"
            "MQTT Username: <input type='text' name='mqttUsername' value='" + config.mqtt_username + "'><br>"
            "MQTT Password: <input type='password' name='mqttPassword' value='" + config.mqtt_password + "'><br>"
            "Client ID: <input type='text' name='clientID' value='" + config.clientID + "'><br>"
            "Raw Value Range (dry-wet)(comma-separated): <input type='text' name='rawValueRange' value='" + String(config.rawValueRange[0]) + "," + String(config.rawValueRange[1]) + "'><br>"
            "Scale Range (dry-wet)(comma-separated): <input type='text' name='scaleRange' value='" + String(config.scaleRange[0]) + "," + String(config.scaleRange[1]) + "'><br>"
            "Relay Pin: <input type='text' name='relayPin' value='" + String(config.relayPin) + "'><br>"
            "Moisture Threshold: <input type='text' name='moistureThreshold' value='" + String(config.moistureThreshold) + "'><br>"
            "Relay On Time: <input type='text' name='relayOnTime' value='" + String(config.relayOnTime) + "'><br>"
            "Number of sensors required to trigger irrigation: <input type='text' name='requiredMoistureSensors' value='" + String(config.requiredMoistureSensors) + "'><br>"
            "Poll Interval (minutes): <input type='text' name='pollInterval' value='" + String(config.pollIntervalMinutes) + "'><br>"
            "Number of Samples: <input type='text' name='numSamples' value='" + String(config.numberOfSamples) + "'><br>"
            "<input type='submit' value='Update'>"
            "</form></body></html>";
        request->send(200, "text/html", html);
    });

    server.on("/submit", HTTP_POST, [](AsyncWebServerRequest *request) {
        // Temporary variables to hold the parsed form inputs
        String tempSensorPins, tempRawValueRange, tempScaleRange;
        // Update config settings from form inputs
        if (request->hasParam("ssid", true)) {
          config.ssid = request->getParam("ssid", true)->value();
        }
        if (request->hasParam("wifiPassword", true)) {
          config.wifi_password = request->getParam("wifiPassword", true)->value();
        }
        if (request->hasParam("mqttServer", true)) {
          config.mqtt_server = request->getParam("mqttServer", true)->value();
        }
        if (request->hasParam("mqttTopic", true)) {
          config.mqtt_topic = request->getParam("mqttTopic", true)->value();
        }
        if (request->hasParam("mqttUsername", true)) {
          config.mqtt_username = request->getParam("mqttUsername", true)->value();
        }
        if (request->hasParam("mqttPassword", true)) {
          config.mqtt_password = request->getParam("mqttPassword", true)->value();
        }
        if (request->hasParam("clientID", true)) {
          config.clientID = request->getParam("clientID", true)->value();
        }
        if (request->hasParam("relayPin", true)) {
          config.relayPin = request->getParam("relayPin", true)->value().toInt();
        }
        if (request->hasParam("moistureThreshold", true)) {
          config.moistureThreshold = request->getParam("moistureThreshold", true)->value().toInt();
        }
        if (request->hasParam("relayOnTime", true)) {
          config.relayOnTime = request->getParam("relayOnTime", true)->value().toInt();
        }
        if (request->hasParam("requiredMoistureSensors", true)) {
          config.requiredMoistureSensors = request->getParam("requiredMoistureSensors", true)->value().toInt();
        }
        if (request->hasParam("pollInterval", true)) {
          config.pollIntervalMinutes = request->getParam("pollInterval", true)->value().toInt();
        }
        if (request->hasParam("numSamples", true)) {
          config.numberOfSamples = request->getParam("numSamples", true)->value().toInt();
        }
        if (request->hasParam("sensorPins", true)) {
          String sensorPins = request->getParam("sensorPins", true)->value();
          parseAndSetSensorPins(sensorPins);
        }
        if (request->hasParam("sensorIdxs", true)) {
          String sensorIdxs = request->getParam("sensorIdxs", true)->value();
          int idxArray[6]; // Temporary array to store parsed indices
          int idx = 0, lastIdx = 0, arrayIdx = 0;
          while ((idx = sensorIdxs.indexOf(',', lastIdx)) != -1 && arrayIdx < 6) {
            idxArray[arrayIdx++] = sensorIdxs.substring(lastIdx, idx).toInt();
            lastIdx = idx + 1;
          }
          idxArray[arrayIdx] = sensorIdxs.substring(lastIdx).toInt(); // Last value
          for (int i = 0; i < 6; i++) {
            config.sensorIdx[i] = idxArray[i];
          }
        }
        saveConfig(); // Save the updated configuration to NVS
        // Redirect back to the form page or indicate success
        request->send(200, "text/html", "<p>Settings updated. <a href='/'>Go back</a></p>");
        delay(3000);
        ESP.restart();
    });
}

void setup() {
  Serial.begin(9600);
  loadConfig();
  connectToNetwork();
  pinMode(config.relayPin, OUTPUT);
  digitalWrite(config.relayPin, LOW);
  setupWebServer();
  server.begin();
}

void loop() {
  static unsigned long lastSensorPollTime = 0;
  if (!mqttClient.connected()) {
    connectToMQTT();
  }
  mqttClient.poll();
  
  if (relayOn && millis() >= relayOffTime) {
    digitalWrite(config.relayPin, LOW);
    relayOn = false;
  }

  if (millis() - lastSensorPollTime > config.pollIntervalMinutes * 60000) { // Convert minutes to milliseconds
    lastSensorPollTime = millis();
    int sensorsBelowThreshold = 0;
    for (int i = 0; i < NUM_SENSORS; i++) {
      int sum = 0;
      for (int j = 0; j < config.numberOfSamples; j++) {
        sum += analogRead(config.SensorPin[i]);
      }
      int average = sum / config.numberOfSamples;
      Serial.printf("Sensor %d Raw Moisture: %d\n", i, average);
      int processedValue = mapSensorValue(average);
      if (processedValue != lastPublishedValues[i]) {
        lastPublishedValues[i] = processedValue;
        Serial.printf("Sensor %d Mapped Moisture: %d\n", i, processedValue);
        // Prepare and send MQTT message with sensor data
        DynamicJsonDocument doc(1024);
        doc["idx"] = config.sensorIdx[i];
        doc["nvalue"] = processedValue;
        doc["svalue"] = String(processedValue);
        String payload;
        serializeJson(doc, payload);
        mqttClient.beginMessage(config.mqtt_topic);
        mqttClient.print(payload);
        mqttClient.endMessage();
      }
      
      if (processedValue < config.moistureThreshold) {
        sensorsBelowThreshold++;
      }
    }

    if (sensorsBelowThreshold >= config.requiredMoistureSensors && !relayOn) {
      digitalWrite(config.relayPin, HIGH);
      relayOn = true;
      relayOffTime = millis() + config.relayOnTime * 1000; // Set the time to turn off the relay
    }
  }
}
